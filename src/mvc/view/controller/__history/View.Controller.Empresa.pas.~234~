{*******************************************************}
{                    API PDV - JSON                     }
{                      ES Sistemas                      }
{          Início do projeto 13/03/2024 17:18           }
{                 www.bemoreweb.com.br                  }
{                     (17)98169-5336                    }
{                        2003/2024                      }
{         Analista desenvolvedor (Eleandro Silva)       }
{*******************************************************}
unit View.Controller.Empresa;

interface

uses
  System.Classes,
  System.SysUtils,
  System.JSON,

  Vcl.StdCtrls,

  Data.DB,

  FireDAC.Comp.Client,

  DataSet.Serialize,
  Horse,
  Horse.BasicAuthentication,
  //GBSwagger.Path.Attributes,

  Controller.Interfaces,
  Imp.Controller;

type
  //[SwagPath('empresa', 'Empresa')]
  TViewControllerEmpresa = class
    private
      FReq        : THorseRequest;
      FRes        : THorseResponse;
      FNext       : TProc;

      FTexto      : String;
      FIdEmpresa  : Integer;
      FIdEndereco : Integer;

      FController : iController;
      FBody       : TJSONValue;
      memoJSON    : TMemo;

      //Json empresa-->tabela pai
      FEmpresaJSONObject  : TJSONObject;
      FEmpresaJSONArray   : TJSONArray;
      //Json - endereco
      FEnderecoJSONObject : TJSONObject;
      FEnderecoJSONArray  : TJSONArray;

      //Json EMail
      FEMailJSONObject    : TJSONObject;
      FEMailJSONArray     : TJSONArray;
      //Json Telefone
      FTelefoneJSONObject : TJSONObject;
      FTelefoneJSONArray  : TJSONArray;

      FDataSourceEmpresa  : TDataSource;
      FDataSourceEndereco : TDataSource;
      FDataSourceEmail    : TDataSource;
      FDataSourceTelefone : TDataSource;

      procedure GetAll   (Req: THorseRequest; Res: THorseResponse; Next : TProc);
      procedure GetbyId  (Req: THorseRequest; Res: THorseResponse; Next : TProc);
      procedure Post     (Req: THorseRequest; Res: THorseResponse; Next : TProc);
      procedure Put      (Req: THorseRequest; Res: THorseResponse; Next : TProc);
      procedure Delete   (Req: THorseRequest; Res: THorseResponse; Next : TProc);

      procedure Registry;

      procedure LoopEmpresa;
      //Infeção de dependência
      function LoopEnderecoEmpresa : Boolean;
      function LoopEmailEmpresa    : Boolean;
      function LoopTelefoneEmpresa : Boolean;

      function BuscaCNPJ(Value : String) : Boolean;
      procedure Horse(Req : THorseRequest; Res : THorseResponse; Next : TProc);
    public
      constructor Create;
      destructor Destroy; override;

  end;

implementation

{ TViewControllerEmpresa }

function TViewControllerEmpresa.BuscaCNPJ(Value : String): Boolean;
begin
  Result := False;
  FController
     .FactoryEntidade
       .DAOEmpresa
         .This
           .CNPJ(Value)
           .&End
         .GetbyParams
         .DataSet(FDataSourceEmpresa);
  if not FDataSourceEmpresa.DataSet.IsEmpty then
    Result := True else Result := False;
end;

constructor TViewControllerEmpresa.Create;
begin
  Horse(FReq, FRes, FNext);

  FController         := TController.New;
  FDataSourceEmpresa  := TDataSource.Create(nil);
  FDataSourceEndereco := TDataSource.Create(nil);
  FDataSourceEmail    := TDataSource.Create(nil);
  FDataSourceTelefone := TDataSource.Create(nil);
  memoJSON   := TMemo.Create(nil);
  Registry;
end;

destructor TViewControllerEmpresa.Destroy;
begin
  FreeAndNil(memoJSON);
  inherited;
end;

//Empresa tabela pai
procedure TViewControllerEmpresa.LoopEmpresa;
begin
  FEmpresaJSONArray := TJSONArray.Create;//Jsonarray Geral
  FDataSourceEmpresa.DataSet.First;
  while not FDataSourceEmpresa.DataSet.Eof do
  begin
    FEmpresaJSONObject := TJSONObject.Create;//JSONObject(Tabela pai---> endereco)
    FEmpresaJSONObject := FDataSourceEmpresa.DataSet.ToJSONObject;

    if LoopEnderecoEmpresa then
      FEmpresaJSONObject.AddPair('endereco' , FEnderecoJSONArray);//Json tabela endereco

    if LoopEmailEmpresa then
      FEmpresaJSONObject.AddPair('emailempresa'    , FEMailJSONArray);//Json tabela emailempresa

    if LoopTelefoneEmpresa then
      FEmpresaJSONObject.AddPair('telefoneempresa' , FTelefoneJSONArray);//Json tabela telefoneempresa

    FEmpresaJSONArray.Add(FEmpresaJSONObject);
    FDataSourceEmpresa.DataSet.Next;
  end;
end;

//Endereco
function TViewControllerEmpresa.LoopEnderecoEmpresa : Boolean;
begin
  Result := False;
  FController
    .FactoryEntidade
      .DAOEnderecoEmpresa
        .This
          .IdEmpresa(FDataSourceEmpresa.DataSet.FieldByName('id').AsInteger)
      .&End
      .GetbyParams
      .DataSet(FDataSourceEndereco);

   if not FDataSourceEndereco.DataSet.IsEmpty then
   begin
     Result := True;
     FEnderecoJSONArray := TJSONArray.Create;//JsonArrayEndereco

     FDataSourceEndereco.DataSet.First;
     while not FDataSourceEndereco.DataSet.Eof do
     begin
       FEnderecoJSONObject := TJSONObject.Create;
       FEnderecoJSONObject := FDataSourceEndereco.DataSet.ToJSONObject;

       FEnderecoJSONArray.Add(FEnderecoJSONObject);

       FDataSourceEndereco.DataSet.Next;
     end;
   end;
end;

//Email
function TViewControllerEmpresa.LoopEmailEmpresa : Boolean;
begin
  Result := False;
  FController
    .FactoryEntidade
      .DAOEmailEmpresa
        .This
          .IdEmpresa(FDataSourceEmpresa.DataSet.FieldByName('id').AsInteger)
      .&End
      .GetbyParams
      .DataSet(FDataSourceEmail);

   if not FDataSourceEmail.DataSet.IsEmpty then
   begin
     Result := True;
     FEMailJSONArray := TJSONArray.Create;//JsonArrayEMail

     FDataSourceEmail.DataSet.First;
     while not FDataSourceEmail.DataSet.Eof do
     begin
       FEMailJSONObject := TJSONObject.Create;
       FEMailJSONObject := FDataSourceEmail.DataSet.ToJSONObject;

       FEMailJSONArray.Add(FEMailJSONObject);

       FDataSourceEmail.DataSet.Next;
     end;
   end;
end;

//Telefone
function TViewControllerEmpresa.LoopTelefoneEmpresa: Boolean;
begin
  Result := False;
  FController
    .FactoryEntidade
      .DAOTelefoneEmpresa
        .This
          .IdEmpresa(FDataSourceEmpresa.DataSet.FieldByName('id').AsInteger)
      .&End
      .GetbyParams
      .DataSet(FDataSourceTelefone);

   if not FDataSourceTelefone.DataSet.IsEmpty then
   begin
     Result := True;
     FTelefoneJSONArray := TJSONArray.Create;//JsonArrayEMail

     FDataSourceTelefone.DataSet.First;
     while not FDataSourceTelefone.DataSet.Eof do
     begin
       FTelefoneJSONObject := TJSONObject.Create;
       FTelefoneJSONObject := FDataSourceTelefone.DataSet.ToJSONObject;

       FTelefoneJSONArray.Add(FTelefoneJSONObject);

       FDataSourceTelefone.DataSet.Next;
     end;
   end;
end;

procedure TViewControllerEmpresa.GetAll(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  lCNPJ, lNomeEmpresarial : String;
begin
  lCNPJ := Req.Query.Field('cnpj').AsString;
  lNomeEmpresarial := Req.Query.Field('nomeempresarial').AsString;
  try
    try
      if ((Req.Query.Field('cnpj').AsString<>'') or (Req.Query.Field('nomeempresarial').AsString<>'')) then
        FController
          .FactoryEntidade
            .DAOEmpresa
              .This
                .CNPJ           (Req.Query.Field('cnpj').AsString)
                .NomeEmpresarial(Req.Query.Field('nomeempresarial').AsString)
              .&End
            .GetbyParams
            .DataSet(FDataSourceEmpresa)
      else
        FController
          .FactoryEntidade
            .DAOEmpresa
              .GetAll
              .DataSet(FDataSourceEmpresa);
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;
  finally
    if not FDataSourceEmpresa.DataSet.IsEmpty then
    begin
      LoopEmpresa;
      Res.Send<TJSONArray>(FEmpresaJSONArray);
      Res.Status(200).Send('');
    end else
      Res.Status(400).Send('Registro não encontrado!')
  end;
end;

procedure TViewControllerEmpresa.GetbyId(Req: THorseRequest; Res: THorseResponse; Next: TProc);
begin
   Try
     Try
       FController
         .FactoryEntidade
           .DAOEmpresa
             .GetbyId(Req.Params['id'].ToInt64)
             .DataSet(FDataSourceEmpresa);
     except
       raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
     end;
   Finally
     if not FDataSourceEmpresa.DataSet.IsEmpty then
    begin
      LoopEmpresa;
      Res.Send<TJSONArray>(FEmpresaJSONArray);
      Res.Status(200).Send('');
    end else
      Res.Status(400).Send('Registro não encontrado!')
   end;
end;

procedure TViewControllerEmpresa.Horse(Req: THorseRequest; Res: THorseResponse; Next: TProc);
begin
  FReq  := Req;
  FRes  := Res;
  FNext := Next;
end;

procedure TViewControllerEmpresa.Post(Req: THorseRequest; Res: THorseResponse; Next: TProc);
Var
  I : Integer;
  LEmpresaObject  : TJSONObject;//JSONObject-empresa

  LEnderecoArray  : TJSONArray; //JSONArray -endereco
  LEnderecoObject : TJSONObject;//JSONObject-endereco
  LNumerosArray   : TJSONArray;//JSONArray-numero
  LNumeroObject   : TJSONObject;//JSONObject-numero
  LEmailArray     : TJSONArray; //JSONArray -email
  LEmailObject    : TJSONObject;//JSONObject-email
  LTelefoneArray  : TJSONArray; //JSONArray -telefone
  LTelefoneObject : TJSONObject;//JSONObject-telefone
begin
  //Lê os dados JSON da requisição (tabela pai='empresa')
  LEmpresaObject := Req.Body<TJSONObject>;
  if BuscaCNPJ(LEmpresaObject.GetValue<String>('cnpj')) then
   raise Res.Status(400).Send('Já conta este CNPJ, cadastrado, impossível cadastrar CNPJ, duplicado!');

  try
    //tabela pai
    try
      FController
          .FactoryEntidade
            .DAOEmpresa
              .This
                .CNPJ                 (LEmpresaObject.GetValue<String>   ('cnpj'))
                .InscricaoEstadual    (LEmpresaObject.GetValue<String>   ('inscricaoestadual'))
                .NomeEmpresarial      (LEmpresaObject.GetValue<String>   ('nomeempresarial'))
                .NomeFantasia         (LEmpresaObject.GetValue<String>   ('nomefantasia'))
                .IdNaturezaJuridica   (LEmpresaObject.GetValue<Integer>  ('idnaturezajuridica'))
                .DataEmissao          (LEmpresaObject.GetValue<TDateTime>('dataemissao'))
                .DataSituacaoCadastral(LEmpresaObject.GetValue<TDateTime>('datasituacaocadastral'))
                .Ativo                (LEmpresaObject.GetValue<integer>  ('ativo'))
              .&End
              .Post
            .DataSet(FDataSourceEmpresa);
        FIdEmpresa := FDataSourceEmpresa.DataSet.FieldByName('id').AsInteger;
      except
        raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;

    //Obtém os dados JSON do corpo da requisição da tabela('endereco')
    LEnderecoArray := LEmpresaObject.GetValue('endereco') as TJSONArray;
    try
      // Loop do(s) endereço(s)
      for I := 0 to LEnderecoArray.Count - 1 do
      begin
        //Extraindo os dados do endereço e salvando no banco de dados
        LEnderecoObject := LEnderecoArray.Items[I] as TJSONObject;

        FController
          .FactoryEntidade
            .DAOEndereco
              .This
                .Cep           (LEnderecoObject.GetValue<String>('cep'))
                .IBGE          (LEnderecoObject.GetValue<Integer>('ibge'))
                .UF            (LEnderecoObject.GetValue<String>('uf'))
                .TipoLogradouro(LEnderecoObject.GetValue<String>('tipologradouro'))
                .Logradouro    (LEnderecoObject.GetValue<String>('logradouro'))
                .Bairro        (LEnderecoObject.GetValue<String>('bairro'))
                .GIA           (LEnderecoObject.GetValue<Integer>('gia'))
                .DDD           (LEnderecoObject.GetValue<String>('ddd'))
              .&End
            .Post
            .DataSet(FDataSourceEndereco);
        FIdEndereco := FDataSourceEndereco.DataSet.FieldByName('id').AsInteger;

        LNumeroObject := TJSONObject(LEnderecoObject.GetValue('numero'));
        //Inserindo dados na tabela numero
        FController
                .FactoryEntidade
                  .DAONumero
                    .This
                      .IdEndereco         (FIdEndereco)
                      .NumeroEndereco     (LNumeroObject.GetValue<String>('numeroendereco'))
                      .ComplementoEndereco(LNumeroObject.GetValue<String>('complementoendereco'))
                      .&End
                  .Post;

        //Inserindo dados na tabela enderecoempresa
        FController
                 .FactoryEntidade
                   .DAOEnderecoEmpresa
                     .This
                       .IdEndereco(FIdEndereco)
                       .IdEmpresa (FIdEmpresa)
                       .&End
                     .Post;
      end;
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;

    //Obtém os dados JSON do corpo da requisição da tabela('emailempresa')
    LEmailArray := LEmpresaObject.GetValue('emailempresa') as TJSONArray;
    try
      //Loop emails
      for I := 0 to LEmailArray.Count - 1 do
      begin
        //Extraindo os dados do(s) emai(s)  e salvando no banco de dados
        LEmailObject :=  LEmailArray.Items[I] as TJSONObject;
        FController
               .FactoryEntidade
                 .DAOEmailEmpresa
                   .This
                     .IdEmpresa(FIdEmpresa)
                     .Email    (LEmailObject.GetValue<String>('email'))
                     .TipoEmail(LEmailObject.GetValue<String>('tipoemail'))
                     .Ativo    (LEmailObject.GetValue<Integer>('ativo'))
                     .&End
                   .Post;
      end;
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;

    //Obtém os dados JSON do corpo da requisição da tabela('telefoneempresa')
    LTelefoneArray := LEmpresaObject.GetValue('telefoneempresa') as TJSONArray;
    try
      //Loop telefone(s)
      for I := 0 to LTelefoneArray.Count - 1 do
      begin
        //Extraindo os dados do(s) telefone(s) e salvando no banco de dados
        LTelefoneObject := LTelefoneArray.Items[I] as TJSONObject;
        FController
               .FactoryEntidade
                 .DAOTelefoneEmpresa
                   .This
                     .IdEmpresa     (FIdEmpresa)
                     .Operadora     (LTelefoneObject.GetValue<String>('operadora'))
                     .DDD           (LTelefoneObject.GetValue<String>('ddd'))
                     .NumeroTelefone(LTelefoneObject.GetValue<String>('numerotelefone'))
                     .TipoTelefone  (LTelefoneObject.GetValue<String>('tipotelefone'))
                     .Ativo        (LTelefoneObject.GetValue<Integer>('ativo'))
                     .&End
                   .Post;
      end;
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;
  finally
    Res.Status(200).Send('Registro incluído com sucesso!');
  end;
end;

procedure TViewControllerEmpresa.Put(Req: THorseRequest; Res: THorseResponse; Next: TProc);
var
  I : Integer;
  LEmpresaObject  : TJSONObject;//JSONObject-empresa

  LEnderecoArray  : TJSONArray; //JSONArray -endereco
  LEnderecoObject : TJSONObject;//JSONObject-endereco
  LNumerosArray   : TJSONArray;//JSONArray-numero
  LNumeroObject   : TJSONObject;//JSONObject-numero
  LEmailArray     : TJSONArray; //JSONArray -email
  LEmailObject    : TJSONObject;//JSONObject-email
  LTelefoneArray  : TJSONArray; //JSONArray -telefone
  LTelefoneObject : TJSONObject;//JSONObject-telefone
begin
  LEmpresaObject := Req.Body<TJSONObject>; //Tabela Pai Empresa
  memoJSON.Text := LEmpresaObject.Format();
  try
    try
      FController
        .FactoryEntidade
          .DAOEmpresa
            .This
              .Id                   (LEmpresaObject.GetValue<Integer>  ('id'))
              .CNPJ                 (LEmpresaObject.GetValue<String>   ('cnpj'))
              .InscricaoEstadual    (LEmpresaObject.GetValue<String>   ('inscricaoestadual'))
              .NomeEmpresarial      (LEmpresaObject.GetValue<String>   ('nomeempresarial'))
              .NomeFantasia         (LEmpresaObject.GetValue<String>   ('nomefantasia'))
              .IdNaturezaJuridica   (LEmpresaObject.GetValue<Integer>  ('idnaturezajuridica'))
              .DataEmissao          (LEmpresaObject.GetValue<TDateTime>('dataemissao'))
              .DataSituacaoCadastral(LEmpresaObject.GetValue<TDateTime>('datasituacaocadastral'))
              .Ativo                (LEmpresaObject.GetValue<Integer>  ('ativo'))
            .&End
          .Put
          .DataSet(FDataSourceEmpresa);
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;

    //Obtém os dados JSON do corpo da requisição da tabela('endereco')
    LEnderecoArray := LEmpresaObject.Get('endereco').JsonValue as TJSONArray;
    memoJSON.Text := LEnderecoArray.Format();
    try
      // Loop do(s) endereço(s)
      for I := 0 to LEnderecoArray.Count - 1 do
      begin
        LEnderecoObject := LEnderecoArray.Items[I] as TJSONObject;

        FController
          .FactoryEntidade
            .DAOEndereco
              .This
                .Id            (LEnderecoObject.GetValue<Integer>('id'))
                .Cep           (LEnderecoObject.GetValue<String>('cep'))
                .IBGE          (LEnderecoObject.GetValue<Integer>('ibge'))
                .UF            (LEnderecoObject.GetValue<String>('uf'))
                .TipoLogradouro(LEnderecoObject.GetValue<String>('tipoLogradouro'))
                .Logradouro    (LEnderecoObject.GetValue<String>('Logradouro'))
                .Bairro        (LEnderecoObject.GetValue<String>('bairro'))
                .GIA           (LEnderecoObject.GetValue<Integer>('gia'))
                .DDD           (LEnderecoObject.GetValue<String>('ddd'))
              .&End
            .Put
            .DataSet(FDataSourceEndereco);


        //Inserindo dados na tabela numero
        LNumeroObject := TJSONObject(LEnderecoObject.GetValue('numero'));
        //LNumerosArray := (LEnderecoArray.Items[I] as TJSONObject).GetValue('numero') as TJSONArray;
        FController
              .FactoryEntidade
                .DAONumero
                  .This
                    .Id                 (LNumeroObject  .GetValue<Integer>('id'))
                    .IdEndereco         (LEnderecoObject.GetValue<Integer>('id'))
                    .NumeroEndereco     (LNumeroObject  .GetValue<String>('numeroendereco'))
                    .ComplementoEndereco(LNumeroObject  .GetValue<String>('complementoendereco'))
                    .&End
                .Put;

        //Inserindo dados na tabela enderecoempresa
        FController
               .FactoryEntidade
                 .DAOEnderecoEmpresa
                   .This
                     .IdEndereco(LEnderecoObject.GetValue<Integer>('id'))
                     .IdEmpresa (LEmpresaObject .GetValue('id').Value.ToInteger)
                     .&End
                   .Put;
      end;
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;

    //Obtém os dados JSON do corpo da requisição da tabela('emailempresa')
    LEmailArray := LEmpresaObject.Get('emailempresa').JsonValue as TJSONArray;
    try
      //Loop emails
      for I := 0 to LEmailArray.Count - 1 do
      begin
        //Extraindo os dados do(s) emai(s)  e salvando no banco de dados
        LEmailObject :=  LEmailArray.Items[I] as TJSONObject;
        FController
               .FactoryEntidade
                 .DAOEmailEmpresa
                   .This
                     .Id       (LEmailObject  .GetValue<Integer>('id'))
                     .IdEmpresa(LEmpresaObject.GetValue<Integer>('id'))
                     .Email    (LEmailObject  .GetValue<String> ('email'))
                     .TipoEmail(LEmailObject  .GetValue<String> ('tipoemail'))
                     .Ativo    (LEmailObject  .GetValue<Integer>('ativo'))
                     .&End
                   .Put;
      end;
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;

    //Obtém os dados JSON do corpo da requisição da tabela('telefoneempresa')
    LTelefoneArray := LEmpresaObject.Get('telefoneempresa').JsonValue as TJSONArray;
    try
      //Loop telefone(s)
      for I := 0 to LTelefoneArray.Count - 1 do
      begin
        //Extraindo os dados do(s) telefone(s) e salvando no banco de dados
        LTelefoneObject := LTelefoneArray.Items[I] as TJSONObject;
        FController
               .FactoryEntidade
                 .DAOTelefoneEmpresa
                   .This
                     .Id            (LTelefoneObject.GetValue<Integer>('id'))
                     .IdEmpresa     (LEmpresaObject .GetValue<Integer>('id'))
                     .Operadora     (LTelefoneObject.GetValue<String> ('operadora'))
                     .DDD           (LTelefoneObject.GetValue<String> ('ddd'))
                     .NumeroTelefone(LTelefoneObject.GetValue<String> ('numerotelefone'))
                     .TipoTelefone  (LTelefoneObject.GetValue<String> ('tipotelefone'))
                     .Ativo         (LTelefoneObject.GetValue<Integer>('ativo'))
                     .&End
                   .Put;
      end;
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    end;
  finally
    Res.Status(204).Send('Registro alterado com sucesso!');
  end;
end;

procedure TViewControllerEmpresa.Delete(Req: THorseRequest; Res: THorseResponse; Next: TProc);
begin
  try
    try
      FController
        .FactoryEntidade
          .DAOEmpresa
            .This
              .Id(Req.Params['id'].ToInt64)
            .&End
          .Delete
          .DataSet(FDataSourceEmpresa);
    except
      raise Res.Status(500).Send('Ocorreu um erro interno no servidor.');
    End;
  Finally
    Res.Status(204).Send('Registro excluído com sucesso!');
  End;
end;

procedure TViewControllerEmpresa.Registry;
begin
  THorse
      .Group
        .Prefix  ('bmw')
          .Get   ('/empresa'     , GetAll)
          .Get   ('/empresa/:id' , GetbyId)
          .Post  ('empresa'      , Post)
          .Put   ('empresa/:id'  , Put)
          .Delete('empresa/:id'  , Delete);
end;

end.
