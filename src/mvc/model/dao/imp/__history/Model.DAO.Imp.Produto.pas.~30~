{*******************************************************}
{                    API PDV - JSON                     }
{                      ES Sistemas                      }
{          Início do projeto 19/03/2024 22:59           }
{                 www.bemoreweb.com.br                  }
{                     (17)98169-5336                    }
{                        2003/2024                      }
{         Analista desenvolvedor (Eleandro Silva)       }
{*******************************************************}
unit Model.DAO.Imp.Produto;

interface

uses
  System.SysUtils,

  Data.DB,

  Uteis,
  Uteis.Tratar.Mensagens,

  Model.DAO.Produto.Interfaces,
  Model.Entidade.Produto.Interfaces,
  Model.Conexao.Firedac.Interfaces,
  Model.Conexao.Query.Interfaces,
  Model.Entidade.Imp.Produto,
  Model.Conexao.Firedac.MySQL.Imp,
  Model.Conexao.Query.Imp;

Type
  TDAOProduto = class(TInterfacedObject, iDAOProduto)
    private
      FProduto : iEntidadeProduto<iDAOProduto>;
      FConexao : iConexao;
      FQuery   : iQuery;
      FUteis   : TUteis;
      FMSG     : TMensagens;

      FDataSet : TDataSet;

      FKey     : String;
      FValue   : String;
   const
      FSQL=('select '+
            'pro.id, '+
            'pro.idempresa, '+
            'pro.idgrupo, '+
            'gp.nome as nomegrupoproduto, '+
            'pro.idunidade, '+
            'up.unidade, '+
            'pro.gtin, '+
            'pro.ceantrib, '+
            'pro.cean, '+
            'pro.nome, '+
            'pro.ncm, '+
            'pro.precocusto, '+
            'pro.aliquotalucro, '+
            'pro.precovendagelado, '+
            'pro.precovendanatural, '+
            'pro.precopromocional, '+
            'pro.estoqueanterior, '+
            'pro.estoquemaximo, '+
            'pro.estoqueminimo, '+
            'pro.estoqueatual, '+
            'pro.origem, '+
            'pro.volume, '+
            'pro.quantidadeembalagem, '+
            'pro.balanca, '+
            'pro.pesoliquido, '+
            'pro.pesobruto, '+
            'pro.ativo '+
            'from produto pro '+
            'inner join grupoproduto   gp on gp.id = pro.idgrupo '+
            'inner join unidadeproduto up on up.id = pro.idunidade ');

      procedure FiltroKey;
      function  FiltroValue(Value : String) : String;
    public
      constructor Create;
      destructor Destroy; override;
      class function New : iDAOProduto;

      function DataSet(DataSource : TDataSource) : iDAOProduto; overload;
      function DataSet                           : TDataSet;    overload;
      function GetAll                            : iDAOProduto;
      function GetbyId(Id : Variant)             : iDAOProduto;
      function GetbyParams                       : iDAOProduto;
      function Post                              : iDAOProduto;
      function Put                               : iDAOProduto;
      function Delete                            : iDAOProduto;

      function This : iEntidadeProduto<iDAOProduto>;
  end;

implementation

{ TDAOProduto }

constructor TDAOProduto.Create;
begin
  FProduto := TEntidadeProduto<iDAOProduto>.New(Self);
  FConexao := TModelConexaoFiredacMySQL.New;
  FQuery   := TQuery.New;
  FUteis   := TUteis.Create;
  FMSG     := TMensagens.Create;
end;

destructor TDAOProduto.Destroy;
begin
  FreeAndNil(FUteis);
  FreeAndNil(FMSG);
  inherited;
end;

class function TDAOProduto.New: iDAOProduto;
begin
  Result := Self.Create;
end;

procedure TDAOProduto.FiltroKey;
begin
  if FProduto.Nome<>''     then FKey := 'nome'     else
  if FProduto.Gtin<>''     then FKey := 'gtin'     else
  if FProduto.cEanTrib<>'' then FKey := 'ceantrib' else
  if FProduto.cEan<>''     then FKey := 'cean';

  FValue := FiltroValue(FKey);
end;

function TDAOProduto.FiltroValue(Value: String): String;
begin
  Result := '';
  if Value ='nome'     then Result := FProduto.Nome     else
  if Value ='gtin'     then Result := FProduto.Gtin     else
  if Value ='ceantrib' then Result := FProduto.cEanTrib else
  if Value = 'cean'    then Result := FProduto.cEan;
end;

function TDAOProduto.DataSet(DataSource: TDataSource): iDAOProduto;
begin
  Result := Self;
  if not Assigned(FDataset) then
    DataSource.DataSet := FQuery.DataSet
  else
    DataSource.DataSet := FDataSet;
end;

function TDAOProduto.DataSet: TDataSet;
begin
  Result := FDataSet;
end;

function TDAOProduto.GetAll: iDAOProduto;
begin
  Result := Self;
  try
    try
      FDataSet := FQuery
                    .SQL(FSQL)
                    .Open
                  .DataSet;
    except
     raise Exception.Create(FMSG.MSGerroGet);
    end;
  finally
    if not FDataSet.IsEmpty then
      FProduto.Id(FDataSet.FieldByName('id').AsInteger) else FProduto.Id(0);
  end;
end;

function TDAOProduto.GetbyId(Id: Variant): iDAOProduto;
begin
  Result := Self;
  try
    try
      FDataSet := FQuery
                    .SQL(FSQL)
                    .Add('where Id=:Id')
                    .Params('Id', Id)
                    .Open
                  .DataSet;
    except
      raise Exception.Create(FMSG.MSGerroGet);
    end;
  finally
    if not FDataSet.IsEmpty then
      FProduto.Id(FDataSet.FieldByName('id').AsInteger) else FProduto.Id(0);
  end;
end;

function TDAOProduto.GetbyParams: iDAOProduto;
begin
  Result := Self;
  try
   try
     FDataSet := FQuery
                   .SQL(FSQL +' where ' + FUteis.Pesquisar(FKey, ';' + FValue))
                   .Open
                 .DataSet;
   except
     raise exception.Create(FMSG.MSGerroGet);
   end;
  finally
   if not FDataSet.IsEmpty then
      FProduto.Id(FDataSet.FieldByName('id').AsInteger) else FProduto.Id(0);
  end;
end;

function TDAOProduto.Post: iDAOProduto;
const
  LSQL=('insert into produto(idempresa, '+
                             'idgrupo, '+
                             'idunidade, '+
                             'gtin, '+
                             'ceantrib, '+
                             'cean, '+
                             'nome, '+
                             'ncm, '+
                             'precocusto, '+
                             'aliquotalucro, '+
                             'precovendagelado, '+
                             'precovendanatural, '+
                             'precopromocional, '+
                             'estoqueanterior, '+
                             'estoquemaximo, '+
                             'estoqueminimo, '+
                             'estoqueatual, '+
                             'origem, '+
                             'volume, '+
                             'quantidadeembalagem, '+
                             'balanca, '+
                             'pesoliquido, '+
                             'pesobruto, '+
                             'ativo '+
                            ')'+
                             ' values '+
                            '('+
                             ':idempresa, '+
                             ':idgrupo, '+
                             ':idunidade, '+
                             ':gtin, '+
                             ':ceantrib, '+
                             ':cean, '+
                             ':nome, '+
                             ':ncm, '+
                             ':precocusto, '+
                             ':aliquotalucro, '+
                             ':precovendagelado, '+
                             ':precovendanatural, '+
                             ':precopromocional, '+
                             ':estoqueanterior, '+
                             ':estoquemaximo, '+
                             ':estoqueminimo, '+
                             ':estoqueatual, '+
                             ':origem, '+
                             ':volume, '+
                             ':quantidadeembalagem, '+
                             ':balanca, '+
                             ':pesoliquido, '+
                             ':pesobruto, '+
                             ':ativo '+
                            ')'
       );
begin
  Result := Self;

  FConexao.StartTransaction;
  try
    try
      FQuery
        .SQL(LSQL)
          .Params('idempresa '          , FProduto.IdEmpresa)
          .Params('idgrupo '            , FProduto.IdGrupo)
          .Params('idunidade '          , FProduto.IdUnidade)
          .Params('gtin'                , FProduto.Gtin)
          .Params('ceantrib'            , FProduto.cEanTrib)
          .Params('cean'                , FProduto.cEan)
          .Params('nome'                , FProduto.Nome)
          .Params('ncm'                 , FProduto.NCM)
          .Params('precocusto'          , FProduto.PrecoCusto)
          .Params('aliquotalucro'       , FProduto.AliquotaLucro)
          .Params('precovendagelado'    , FProduto.PrecoVendaGelado)
          .Params('precovendanatural'   , FProduto.PrecoVendaNatural)
          .Params('precopromocional'    , FProduto.PrecoVendaPromocional)
          .Params('estoqueanterior'     , FProduto.PrecoVendaPromocional)
          .Params('estoquemaximo'       , FProduto.PrecoVendaPromocional)
          .Params('estoqueminimo'       , FProduto.PrecoVendaPromocional)
          .Params('estoqueatual'        , FProduto.PrecoVendaPromocional)
          .Params('origem'              , FProduto.PrecoVendaPromocional)
          .Params('volume'              , FProduto.PrecoVendaPromocional)
          .Params('quantidadeembalagem' , FProduto.PrecoVendaPromocional)
          .Params('balanca'             , FProduto.PrecoVendaPromocional)
          .Params('pesoliquido'         , FProduto.PrecoVendaPromocional)
          .Params('pesobruto'           , FProduto.PrecoVendaPromocional)
          .Params('ativo'               , FProduto.PrecoVendaPromocional)
        .ExecSQL;
    except
      FConexao.Rollback;
      raise Exception.Create(FMSG.MSGerroPost);
    end;
  finally
    FConexao.Commit;
    FDataSet := FQuery
                    .SQL('select LAST_INSERT_ID () as id')
                    .Open
                    .DataSet;
    FProduto.Id(FDataSet.FieldByName('id').AsInteger);
  end;
end;

function TDAOProduto.Put: iDAOProduto;
const
  LSQL=('update produto set '+
                'idempresa          :idempresa, '+
                'idgrupo            :idgrupo, '+
                'idunidade          :idunidade, '+
                'gtin               :gtin, '+
                'ceantrib           :ceantrib, '+
                'cean               :cean, '+
                'nome               :nome, '+
                'ncm                :ncm, '+
                'precocusto         :precocusto, '+
                'aliquotalucro      :aliquotalucro, '+
                'precovendagelado   :precovendagelado, '+
                'precovendanatural  :precovendanatural, '+
                'precopromocional   :precopromocional, '+
                'estoqueanterior    :estoqueanterior, '+
                'estoquemaximo      :estoquemaximo, '+
                'estoqueminimo      :estoqueminimo, '+
                'estoqueatual       :estoqueatual, '+
                'origem             :origem, '+
                'volume             :volume, '+
                'quantidadeembalagem:quantidadeembalagem, '+
                'balanca            :balanca, '+
                'pesoliquido        :pesoliquido, '+
                'pesobruto          :pesobruto, '+
                'ativo              :ativo '+
                'where id=:id '
       );
begin
  Result := Self;

  FConexao.StartTransaction;
  try
    try
      FQuery
        .SQL(LSQL)
          .Params('id'                  , FProduto.Id)
          .Params('idempresa '          , FProduto.IdEmpresa)
          .Params('idgrupo '            , FProduto.IdGrupo)
          .Params('idunidade '          , FProduto.IdUnidade)
          .Params('gtin'                , FProduto.Gtin)
          .Params('ceantrib'            , FProduto.cEanTrib)
          .Params('cean'                , FProduto.cEan)
          .Params('nome'                , FProduto.Nome)
          .Params('ncm'                 , FProduto.NCM)
          .Params('precocusto'          , FProduto.PrecoCusto)
          .Params('aliquotalucro'       , FProduto.AliquotaLucro)
          .Params('precovendagelado'    , FProduto.PrecoVendaGelado)
          .Params('precovendanatural'   , FProduto.PrecoVendaNatural)
          .Params('precopromocional'    , FProduto.PrecoVendaPromocional)
          .Params('estoqueanterior'     , FProduto.PrecoVendaPromocional)
          .Params('estoquemaximo'       , FProduto.PrecoVendaPromocional)
          .Params('estoqueminimo'       , FProduto.PrecoVendaPromocional)
          .Params('estoqueatual'        , FProduto.PrecoVendaPromocional)
          .Params('origem'              , FProduto.PrecoVendaPromocional)
          .Params('volume'              , FProduto.PrecoVendaPromocional)
          .Params('quantidadeembalagem' , FProduto.PrecoVendaPromocional)
          .Params('balanca'             , FProduto.PrecoVendaPromocional)
          .Params('pesoliquido'         , FProduto.PrecoVendaPromocional)
          .Params('pesobruto'           , FProduto.PrecoVendaPromocional)
          .Params('ativo'               , FProduto.PrecoVendaPromocional)
        .ExecSQL;
    except
      FConexao.Rollback;
      raise Exception.Create(FMSG.MSGerroPut);
    end;
  finally
    FConexao.Commit;
    //Criar MSG
  end;
end;

function TDAOProduto.Delete: iDAOProduto;
const
  LSQL=('delete from produto where id=:id ');
begin
  Result := self;
  FConexao.StartTransaction;
  try
    try
      FQuery.SQL(LSQL)
               .Params('id', FProduto.Id)
            .ExecSQL;
    except
      FConexao.Rollback;
      raise Exception.Create(FMSG.MSGerroDelete);
    end;
  finally
    FConexao.Commit;
    //Criar MSG
  end;
end;

function TDAOProduto.This: iEntidadeProduto<iDAOProduto>;
begin
  Result := FProduto;
end;

end.
